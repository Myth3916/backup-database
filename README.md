# Домашнее задание: Резервное копирование баз данных - Шаров Олег

## Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.

### Ответы

#### 1.1. Восстановление данных в полном объёме за предыдущий день

**Решение:** Ежедневное полное резервное копирование (Full Backup).

**Обоснование:**
- Каждую ночь (например, в 02:00) выполняется полная копия всей базы данных.
- При поломке утром достаточно восстановить один файл бэкапа за предыдущие сутки.
- Простота восстановления: не требуется цепочка файлов, как при инкрементном/дифференциальном подходе.

**Пример команды (PostgreSQL):**
```bash
pg_dump -U postgres finance_db > /backup/finance_db_$(date +%F).sql
```

#### 1.2. Восстановление данных за час до предполагаемой поломки
**Решение** : PITR (Point-in-Time Recovery) на основе:
1. Базового полного бэкапа
2. Непрерывной архивации логов транзакций (WAL для PostgreSQL, binlog для MySQL)
**Обоснование** :
- Полный бэкап создаётся раз в сутки (базовая точка).
- Логи транзакций архивируются непрерывно (каждые несколько секунд/минут).
- При восстановлении можно указать точное время (например, 2026-02-19 09:00:00), чтобы вернуть состояние БД на час до поломки.
- Минимизирует потерю данных — критично для финансовых систем.
**Пример настройки WAL-архивации (PostgreSQL)** :

```ini
# postgresql.conf
archive_mode = on
archive_command = 'cp %p /backup/wal/%f'
```

---

## Задание 2. PostgreSQL

### 2.1. Примеры команд резервного копирования и восстановления

#### Вариант 1: Формат Plain SQL (текстовый)

**Создание бэкапа:**
```bash
pg_dump -U postgres finance_db > finance_db_$(date +%F).sql
```
**Восстановление**:

```bash
# Создаём пустую БД
createdb -U postgres finance_db_restored

# Восстанавливаем данные
psql -U postgres -d finance_db_restored < finance_db_2026-02-19.sql
```

**Пояснение**:

- `>` — перенаправление вывода в файл
- `date +%F` — автоматическая дата в имени файла (формат: `2026-02-19`)
- `<` — подача файла на вход `psql`


**Вариант 2: Формат Custom (бинарный, сжатый)**

**Создание бэкапа** :

```bash
pg_dump -U postgres -Fc finance_db > finance_db_$(date +%F).dump
```

**Восстановление** :

```bash
# Создаём пустую БД
createdb -U postgres finance_db_restored

# Восстанавливаем данные
pg_restore -U postgres -d finance_db_restored finance_db_2026-02-19.dump
```

**Пояснение** :

- `-Fc` — формат Custom (сжатый)
- `pg_restore` — утилита для восстановления бинарных бэкапов
- Возможность восстановить отдельные таблицы:
`pg_restore -U postgres -d finance_db_restored -t users finance_db_2026-02-19.dump`


### Краткая таблица команд

| Операция | Формат | Команда |
|----------|--------|---------|
| **Бэкап** | Plain SQL | `pg_dump -U postgres finance_db > finance_db_$(date +%F).sql` |
| **Восстановление** | Plain SQL | `psql -U postgres -d finance_db_restored < finance_db_2026-02-19.sql` |
| **Бэкап** | Custom (бинарный) | `pg_dump -U postgres -Fc finance_db > finance_db_$(date +%F).dump` |
| **Восстановление** | Custom (бинарный) | `pg_restore -U postgres -d finance_db_restored finance_db_2026-02-19.dump` |


